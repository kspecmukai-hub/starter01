<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>starter01 | Camera Base</title>
  <style>
    :root { --ui-bg:#111; --ui-card:#1a1a1a; --ui-fg:#fff; --ui-accent:#4ade80; }
    *{ box-sizing:border-box }
    html,body{ height:100%; margin:0 }
    body{ background:#000; color:#eaeaea; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif }

    /* ステージ */
    #stage{ position:relative; width:100vw; height:100vh; overflow:hidden; background:#000 }
    #video{ position:absolute; inset:0; width:100%; height:100%; object-fit:cover; background:#000 }
    .mirror{ transform:scaleX(-1) }

    /* 服PNG（肩追従・フェードイン） */
    #garment{
      position:absolute; top:50%; left:50%;
      transform:translate(-50%,-50%); max-width:none; /* ← スケールで制御 */
      pointer-events:none;
      opacity:0; transition:opacity .22s ease;
      image-rendering:auto;
    }
    #garment.on{ opacity:1 }

    /* スタート画面 */
    #startScreen{ position:absolute; inset:0; display:grid; place-items:center; background:rgba(0,0,0,.55) }
    #startCard{ background:#fff; color:#111; padding:20px 24px; border-radius:16px; width:min(92vw,520px); box-shadow:0 8px 32px rgba(0,0,0,.35) }
    #startCard h1{ margin:0 0 10px; font-size:20px }
    #startCard p{ margin:0 0 14px; line-height:1.6 }
    #startBtn{ width:100%; padding:12px 16px; border-radius:12px; border:0; font-size:16px; cursor:pointer; background:#111; color:#fff }

    /* 右下トグル & パネル */
    #toggle{ position:fixed; right:16px; bottom:16px; width:52px; height:52px; border-radius:999px; border:0; background:var(--ui-accent); color:#111; font-size:22px; box-shadow:0 8px 28px rgba(0,0,0,.35); cursor:pointer }
    #panel{ position:fixed; right:16px; bottom:86px; width:min(92vw,360px); background:var(--ui-card); color:var(--ui-fg); border:1px solid #2a2a2a; border-radius:16px; box-shadow:0 20px 40px rgba(0,0,0,.45); padding:12px; transform-origin:100% 100%; transform:scale(.9); opacity:0; pointer-events:none; transition:.18s ease }
    #panel.open{ transform:scale(1); opacity:1; pointer-events:auto }
    #panel h2{ margin:4px 6px 10px; font-size:14px; font-weight:600; opacity:.9 }
    .row{ display:flex; align-items:center; gap:8px; margin:8px 6px }
    .row label{ min-width:110px; font-size:14px; opacity:.9 }
    .hint{ margin:6px; font-size:12px; opacity:.7 }
    #badge{ font-size:12px; padding:2px 8px; border-radius:999px; background:#333; color:#fff }

    #log{ position:fixed; left:50%; bottom:16px; transform:translateX(-50%); background:#111; color:#fff; padding:6px 10px; border-radius:10px; font-size:12px; box-shadow:0 8px 28px rgba(0,0,0,.35); max-width:92vw; text-align:center; display:none }
  </style>
</head>
<body>
  <div id="stage" aria-label="camera stage">
    <video id="video" autoplay playsinline muted></video>
    <img id="garment" src="public/garments/trainer.png" alt="garment"/>
    <div id="startScreen"><div id="startCard">
      <h1>カメラの準備をします</h1>
      <p>「カメラを開始」を押すと、ブラウザからカメラ許可を聞かれます。インカメで開始し、ミラー表示（左右反転）になります。</p>
      <button id="startBtn">カメラを開始</button>
      <p class="hint">※ 後から右下の⚙で「アウトカメ／ミラーOFF」に切替できます。</p>
    </div></div>
  </div>

  <button id="toggle" title="設定">⚙</button>

  <div id="panel" role="dialog" aria-modal="false" aria-label="設定">
    <h2>設定</h2>
    <div class="row"><label for="modeBtn">カメラ</label><button id="modeBtn" type="button">イン（ミラーON）に起動中</button></div>
    <div class="row"><label for="mirrorChk">ミラー</label><input id="mirrorChk" type="checkbox" checked /></div>
    <div class="row"><label for="deviceSel">デバイス</label><select id="deviceSel"></select></div>

    <div class="row"><label for="showGarment">服表示</label><input id="showGarment" type="checkbox" /></div>

    <div class="row"><label for="autoFitChk">オート調整</label><input id="autoFitChk" type="checkbox" checked /></div>
    <div class="row"><label for="fitGain">フィット微調整</label><input id="fitGain" type="range" min="80" max="120" value="100" /> <span id="fitGainVal">100%</span></div>

    <div class="row"><label for="posX">横位置（微調整）</label><input id="posX" type="range" min="-40" max="40" value="0" /></div>
    <div class="row"><label for="posY">縦位置（微調整）</label><input id="posY" type="range" min="-40" max="40" value="0" /></div>
    <div class="row"><label for="scale">サイズ（手動）</label><input id="scale" type="range" min="50" max="150" value="100" /></div>

    <div class="row"><label>肩検出</label><span id="badge">初期化中…</span></div>
    <div class="row"><button id="stopBtn" type="button">停止</button><button id="restartBtn" type="button">再起動</button></div>
    <p class="hint">肩が映っている時だけ自動で表示（手動ONとのAND）。検出できない環境では手動表示を維持します。</p>
  </div>

  <div id="log" role="status"></div>

  <!-- ローカルESM（CDN不使用） -->
  <script type="module">
    import * as vision from './vendor/mediapipe/vision_bundle.mjs';
    const { FilesetResolver, PoseLandmarker } = vision;
    const WASM_BASE = './vendor/mediapipe/wasm';

    let stream=null, facing='user';
    let landmarker=null, landmarkerReady=false, shoulderOK=false;
    let lastVideoTime=-1;

    // 追従＆スケール
    let smoothX=null, smoothY=null;
    let autoScale=1;                      // 自動スケール係数
    let GARMENT_CHEST_PX=null;            // 服PNGの肩幅（px）
    const ALPHA=0.35;                     // 位置スムージング

    const els = {
      stage: document.getElementById('stage'),
      video: document.getElementById('video'),
      garment: document.getElementById('garment'),
      startScreen: document.getElementById('startScreen'),
      startBtn: document.getElementById('startBtn'),
      toggle: document.getElementById('toggle'),
      panel: document.getElementById('panel'),
      modeBtn: document.getElementById('modeBtn'),
      mirrorChk: document.getElementById('mirrorChk'),
      deviceSel: document.getElementById('deviceSel'),
      showGarment: document.getElementById('showGarment'),
      autoFitChk: document.getElementById('autoFitChk'),
      fitGain: document.getElementById('fitGain'),
      fitGainVal: document.getElementById('fitGainVal'),
      posX: document.getElementById('posX'),
      posY: document.getElementById('posY'),
      scale: document.getElementById('scale'),
      stopBtn: document.getElementById('stopBtn'),
      restartBtn: document.getElementById('restartBtn'),
      badge: document.getElementById('badge'),
      log: document.getElementById('log'),
    };

    const toast=(m,ms=2200)=>{ els.log.textContent=m; els.log.style.display='block';
      clearTimeout(els.log._t); els.log._t=setTimeout(()=>els.log.style.display='none',ms); };
    const stopStream=()=>{ if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; } };
    const vminPX=()=> Math.min(innerWidth, innerHeight)/100;

    // garmentのtransformだけを更新（位置はtickでleft/topを更新）
    function updateGarmentTransform(){
      const dx = +els.posX.value * vminPX();
      const dy = +els.posY.value * vminPX();
      const manual = +els.scale.value/100;
      const gain   = +els.fitGain.value/100;
      const mirror = els.mirrorChk.checked ? -1 : 1;

      const s = (els.autoFitChk.checked ? autoScale*gain : 1) * manual;
      els.garment.style.transform =
        `translate(-50%,-50%) scaleX(${mirror}) translate(${dx}px, ${dy}px) scale(${s})`;
    }

    function applyMirror(){ els.video.classList.toggle('mirror', els.mirrorChk.checked); updateGarmentTransform(); }
    function setModeLabel(){ const isUser=facing==='user';
      els.modeBtn.textContent=isUser?'イン（ミラーON）に起動中':'アウト（反転OFF）に起動中';
      els.mirrorChk.checked=isUser; applyMirror(); }
    function refreshGarmentDisplay(){ const on = els.showGarment.checked && shoulderOK; els.garment.classList.toggle('on', on); }
    const setBadge=(ok,text,color)=>{ els.badge.textContent=text; els.badge.style.background=color; };

    async function startCamera({deviceId}={}){
      try{
        stopStream();
        const constraints = deviceId? {video:{deviceId:{exact:deviceId}},audio:false}
                                    : {video:{facingMode:facing},audio:false};
        stream = await navigator.mediaDevices.getUserMedia(constraints);
        els.video.srcObject = stream;

        const devices=await navigator.mediaDevices.enumerateDevices();
        const cams=devices.filter(d=>d.kind==='videoinput'); const prev=els.deviceSel.value;
        els.deviceSel.innerHTML=''; cams.forEach(d=>{const o=document.createElement('option');
          o.value=d.deviceId; o.textContent=d.label||`カメラ ${els.deviceSel.length+1}`; els.deviceSel.appendChild(o);});
        if(deviceId && cams.some(c=>c.deviceId===deviceId)) els.deviceSel.value=deviceId;
        else if(cams.some(c=>c.deviceId===prev)) els.deviceSel.value=prev;

        smoothX = smoothY = null; // 位置スムージング初期化
        toast('カメラを開始しました'); setModeLabel();
      }catch(e){ console.error(e); toast('カメラを開始できませんでした。別のブラウザ/端末も試してください。'); }
    }

    async function initPose(){
      try{
        setBadge(false,'初期化中…','#555');
        const fileset = await FilesetResolver.forVisionTasks(WASM_BASE);
        landmarker = await PoseLandmarker.createFromOptions(fileset, {
          baseOptions:{ modelAssetPath: `${WASM_BASE}/pose_landmarker_lite.task` },
          runningMode:'VIDEO', numPoses:1
        });
        landmarkerReady=true; setBadge(true,'検出準備OK','#2ea043'); toast('肩検出の準備ができました');
        requestAnimationFrame(tick);
      }catch(e){
        console.warn('Pose 初期化に失敗:', e);
        landmarkerReady=false; shoulderOK=false; setBadge(false,'未対応（手動表示）','#777');
      }
    }

    // メインループ
    function tick(){
      if(!landmarkerReady || !els.video.srcObject){ requestAnimationFrame(tick); return; }
      const vtime=Math.round(els.video.currentTime*1000); if(vtime===lastVideoTime){ requestAnimationFrame(tick); return; }
      lastVideoTime=vtime;

      const res=landmarker.detectForVideo(els.video, performance.now());
      let ok=false, cxN=0.5, cyN=0.5, shoulderDistPX=null;

      if(res?.landmarks?.length){
        const lm=res.landmarks[0], L=lm[11], R=lm[12];
        if(L && R){
          // 正規化→画面座標の準備
          const stageRect = els.stage.getBoundingClientRect();
          const videoRect = els.video.getBoundingClientRect();
          const baseX = videoRect.left - stageRect.left;
          const baseY = videoRect.top  - stageRect.top;

          // 肩の中点（正規化）
          cxN = (L.x + R.x)/2;
          if(els.mirrorChk.checked) cxN = 1 - cxN;
          cyN = (L.y + R.y)/2;

          // 肩幅（px）
          const lx = (els.mirrorChk.checked ? (1-L.x) : L.x) * videoRect.width;
          const rx = (els.mirrorChk.checked ? (1-R.x) : R.x) * videoRect.width;
          const ly = L.y * videoRect.height;
          const ry = R.y * videoRect.height;
          shoulderDistPX = Math.hypot(rx-lx, ry-ly);

          // 中点をpxにしてスムージング
          const cxPX = baseX + cxN * videoRect.width;
          const cyPX = baseY + cyN * videoRect.height;
          if(smoothX==null){ smoothX=cxPX; smoothY=cyPX; }
          else{ smoothX = ALPHA*cxPX + (1-ALPHA)*smoothX; smoothY = ALPHA*cyPX + (1-ALPHA)*smoothY; }
          els.garment.style.left = `${smoothX}px`;
          els.garment.style.top  = `${smoothY}px`;

          // オートスケール（肩幅px / 服肩幅px）
          if(shoulderDistPX && GARMENT_CHEST_PX){
            autoScale = shoulderDistPX / GARMENT_CHEST_PX;
          }

          const vis=((L.visibility??1)>0.5)&&((R.visibility??1)>0.5);
          const inFrame= L.y>0 && L.y<1 && R.y>0 && R.y<1;
          ok = vis && inFrame;
        }
      }
      shoulderOK = ok;
      setBadge(ok, ok?'検出中':'未検出', ok?'#2ea043':'#555');

      updateGarmentTransform();  // スケール・微調整反映
      refreshGarmentDisplay();
      requestAnimationFrame(tick);
    }

    // UIイベント
    els.startBtn.addEventListener('click', async ()=>{
      els.startBtn.disabled=true; await startCamera(); els.startScreen.style.display='none';
      if(!landmarkerReady) initPose();
    });
    els.toggle.addEventListener('click', ()=> els.panel.classList.toggle('open'));
    els.modeBtn.addEventListener('click', async ()=>{ facing=(facing==='user')?'environment':'user'; await startCamera(); });
    els.mirrorChk.addEventListener('change', applyMirror);
    els.deviceSel.addEventListener('change', async ()=>{ await startCamera({deviceId:els.deviceSel.value}); });
    els.stopBtn.addEventListener('click', ()=>{ stopStream(); toast('カメラを停止しました'); });
    els.restartBtn.addEventListener('click', async ()=>{ await startCamera(); });

    els.showGarment.addEventListener('change', refreshGarmentDisplay);
    [els.posX, els.posY, els.scale, els.fitGain].forEach(el=> el.addEventListener('input', ()=>{
      if(el===els.fitGain) els.fitGainVal.textContent = `${els.fitGain.value}%`;
      updateGarmentTransform();
    }));
    els.autoFitChk.addEventListener('change', updateGarmentTransform);

    // 初期適用
    updateGarmentTransform(); refreshGarmentDisplay();

    // garments.json から服の肩幅pxヒントを取得（今回 980）
    (async()=>{
      try{
        const r=await fetch('garments.json',{cache:'no-store'}); if(!r.ok) throw 0;
        const data=await r.json(); const key=Object.keys(data)[0]; const cfg=data[key]||{};
        if(typeof cfg.px_chest_hint==='number' && cfg.px_chest_hint>0){ GARMENT_CHEST_PX = cfg.px_chest_hint; }
      }catch(_){}
      // 念のため画像ロード後に未設定なら推定
      els.garment.addEventListener('load', ()=>{
        if(!GARMENT_CHEST_PX){ GARMENT_CHEST_PX = els.garment.naturalWidth * 0.70; }
      }, {once:true});
    })();

    // 画面サイズ変化時の再適用
    addEventListener('resize', ()=>{ updateGarmentTransform(); });
  </script>
</body>
</html>

