<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>starter01 | Camera Base</title>
  <style>
    :root { --ui-bg:#111; --ui-card:#1a1a1a; --ui-fg:#fff; --ui-accent:#4ade80; }
    * { box-sizing: border-box; }
    html,body { height:100%; margin:0; }
    body { background:#000; color:#eaeaea; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }

    #stage { position:relative; width:100vw; height:100vh; overflow:hidden; background:#000; }
    #video { position:absolute; inset:0; width:100%; height:100%; object-fit:cover; background:#000; }
    .mirror { transform: scaleX(-1); }

    #garment {
      position:absolute; top:50%; left:50%;
      transform:translate(-50%,-50%); /* JSで上書き */
      max-width:60vmin; display:none; pointer-events:none;
    }

    #startScreen { position:absolute; inset:0; display:grid; place-items:center; background:rgba(0,0,0,.55); }
    #startCard { background:#fff; color:#111; padding:20px 24px; border-radius:16px; width:min(92vw,520px); box-shadow:0 8px 32px rgba(0,0,0,.35); }
    #startCard h1 { margin:0 0 10px; font-size:20px; }
    #startCard p { margin:0 0 14px; line-height:1.6; }
    #startBtn { width:100%; padding:12px 16px; border-radius:12px; border:0; font-size:16px; cursor:pointer; background:#111; color:#fff; }
    #startBtn:disabled { opacity:.6; cursor:not-allowed; }

    #toggle { position:fixed; right:16px; bottom:16px; width:52px; height:52px; border-radius:999px; border:0; background:var(--ui-accent); color:#111; font-size:22px; box-shadow:0 8px 28px rgba(0,0,0,.35); cursor:pointer; }
    #panel { position:fixed; right:16px; bottom:86px; width:min(92vw,360px); background:var(--ui-card); color:var(--ui-fg); border:1px solid #2a2a2a; border-radius:16px; box-shadow:0 20px 40px rgba(0,0,0,.45); padding:12px; transform-origin:100% 100%; transform:scale(.9); opacity:0; pointer-events:none; transition:.18s ease; }
    #panel.open { transform:scale(1); opacity:1; pointer-events:auto; }
    #panel h2 { margin:4px 6px 10px; font-size:14px; font-weight:600; opacity:.9; }
    .row { display:flex; align-items:center; gap:8px; margin:8px 6px; }
    .row label { min-width:90px; font-size:14px; opacity:.9; }
    .row select, .row button, .row input[type="checkbox"] { font-size:14px; }
    .hint { margin:6px; font-size:12px; opacity:.7; }
    #badge { font-size:12px; padding:2px 8px; border-radius:999px; background:#333; color:#fff; }
    #log { position:fixed; left:50%; bottom:16px; transform:translateX(-50%); background:#111; color:#fff; padding:6px 10px; border-radius:10px; font-size:12px; box-shadow:0 8px 28px rgba(0,0,0,.35); max-width:92vw; text-align:center; display:none; }
  </style>

  <!-- MediaPipe Tasks Vision（グローバル版）＋フォールバック -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/vision_bundle.js"></script>
  <script>
    if (!('FilesetResolver' in window)) {
      var s = document.createElement('script');
      s.src = 'https://unpkg.com/@mediapipe/tasks-vision@0.10.3/vision_bundle.js';
      document.head.appendChild(s);
    }
  </script>
</head>
<body>
  <div id="stage" aria-label="camera stage">
    <video id="video" autoplay playsinline muted></video>
    <img id="garment" src="public/garments/trainer.png" alt="garment"/>
    <div id="startScreen" aria-live="polite">
      <div id="startCard">
        <h1>カメラの準備をします</h1>
        <p>「カメラを開始」を押すと、ブラウザからカメラ許可を聞かれます。<br>インカメで開始し、ミラー表示（左右反転）になります。</p>
        <button id="startBtn">カメラを開始</button>
        <p class="hint">※ 後から右下の⚙で「アウトカメ／ミラーOFF」に切替できます。</p>
      </div>
    </div>
  </div>

  <button id="toggle" title="設定">⚙</button>

  <div id="panel" role="dialog" aria-modal="false" aria-label="設定">
    <h2>設定</h2>

    <div class="row">
      <label for="modeBtn">カメラ</label>
      <button id="modeBtn" type="button">イン（ミラーON）に起動中</button>
    </div>

    <div class="row">
      <label for="mirrorChk">ミラー</label>
      <input id="mirrorChk" type="checkbox" checked />
    </div>

    <div class="row">
      <label for="deviceSel">デバイス</label>
      <select id="deviceSel"></select>
    </div>

    <!-- 手動表示と微調整 -->
    <div class="row">
      <label for="showGarment">服表示</label>
      <input id="showGarment" type="checkbox" />
    </div>
    <div class="row">
      <label for="posX">横位置</label>
      <input id="posX" type="range" min="-40" max="40" value="0" />
    </div>
    <div class="row">
      <label for="posY">縦位置</label>
      <input id="posY" type="range" min="-40" max="40" value="0" />
    </div>
    <div class="row">
      <label for="scale">サイズ</label>
      <input id="scale" type="range" min="50" max="150" value="100" />
    </div>

    <!-- 肩検出の状態表示 -->
    <div class="row">
      <label>肩検出</label>
      <span id="badge">初期化中…</span>
    </div>

    <div class="row">
      <button id="stopBtn" type="button">停止</button>
      <button id="restartBtn" type="button">再起動</button>
    </div>
    <p class="hint">肩が映っている時だけ自動で表示（手動ONとのAND）。検出できない環境では手動表示を維持します。</p>
  </div>

  <div id="log" role="status"></div>

  <script>
    // ===== 基本状態 =====
    let stream = null;
    let facing = 'user';
    let landmarker = null;
    let landmarkerReady = false;
    let shoulderOK = true;   // 未対応でも手動表示できるよう true 始まり
    let lastVideoTime = -1;

    const els = {
      video: document.getElementById('video'),
      garment: document.getElementById('garment'),
      startScreen: document.getElementById('startScreen'),
      startBtn: document.getElementById('startBtn'),
      toggle: document.getElementById('toggle'),
      panel: document.getElementById('panel'),
      modeBtn: document.getElementById('modeBtn'),
      mirrorChk: document.getElementById('mirrorChk'),
      deviceSel: document.getElementById('deviceSel'),
      showGarment: document.getElementById('showGarment'),
      posX: document.getElementById('posX'),
      posY: document.getElementById('posY'),
      scale: document.getElementById('scale'),
      stopBtn: document.getElementById('stopBtn'),
      restartBtn: document.getElementById('restartBtn'),
      badge: document.getElementById('badge'),
      log: document.getElementById('log'),
    };

    // ===== ユーティリティ =====
    function toast(msg, ms=2200){
      els.log.textContent = msg;
      els.log.style.display = 'block';
      clearTimeout(els.log._t);
      els.log._t = setTimeout(()=> els.log.style.display='none', ms);
      console.info('[INFO]', msg);
    }
    function stopStream(){ if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; } }
    function updateGarmentTransform(){
      const dx = Number(els.posX.value);
      const dy = Number(els.posY.value);
      const s  = Number(els.scale.value) / 100;
      const mirror = els.mirrorChk.checked ? -1 : 1;
      els.garment.style.transform =
        `translate(-50%,-50%) scaleX(${mirror}) translate(${dx}vmin, ${dy}vmin) scale(${s})`;
    }
    function applyMirror(){
      const on = els.mirrorChk.checked;
      els.video.classList.toggle('mirror', on);
      updateGarmentTransform();
    }
    function setModeLabel(){
      const isUser = facing === 'user';
      els.modeBtn.textContent = isUser ? 'イン（ミラーON）に起動中' : 'アウト（反転OFF）に起動中';
      els.mirrorChk.checked = isUser;
      applyMirror();
    }
    function refreshGarmentDisplay(){
      const show = els.showGarment.checked && shoulderOK;
      els.garment.style.display = show ? 'block' : 'none';
    }
    function setBadge(ok, text, color){ els.badge.textContent=text; els.badge.style.background=color; }

    // ===== カメラ =====
    async function startCamera({ deviceId } = {}){
      try{
        stopStream();
        const constraints = deviceId
          ? { video: { deviceId: { exact: deviceId } }, audio:false }
          : { video: { facingMode: facing }, audio:false };
        stream = await navigator.mediaDevices.getUserMedia(constraints);
        els.video.srcObject = stream;

        const devices = await navigator.mediaDevices.enumerateDevices();
        const cams = devices.filter(d => d.kind === 'videoinput');
        const prev = els.deviceSel.value;
        els.deviceSel.innerHTML = '';
        cams.forEach(d=>{
          const opt=document.createElement('option');
          opt.value=d.deviceId;
          opt.textContent=d.label || `カメラ ${els.deviceSel.length+1}`;
          els.deviceSel.appendChild(opt);
        });
        if(deviceId && cams.some(c=>c.deviceId===deviceId)){ els.deviceSel.value = deviceId; }
        else if(cams.some(c=>c.deviceId===prev)){ els.deviceSel.value = prev; }

        setModeLabel();
        toast('カメラを開始しました');
      }catch(err){
        console.error(err);
        toast('カメラを開始できませんでした。別のデバイスやブラウザを試してください。');
      }
    }

    // ===== vision_bundle.js のロード完了を待つ =====
    async function waitVision(ms=8000){
      const t0 = performance.now();
      while(!(window.FilesetResolver && window.PoseLandmarker)){
        if(performance.now()-t0>ms) throw new Error('tasks-vision not loaded');
        await new Promise(r=>setTimeout(r,100));
      }
    }

    // ===== Pose 初期化（グローバルAPI） =====
    async function initPose(){
      try{
        setBadge(false, '初期化中…', '#555');
        await waitVision(); // ここで FilesetResolver / PoseLandmarker の到着を待つ

        // 読み込めたCDNに合わせて wasm のベースURLを決定
        const script = Array.from(document.scripts).find(s =>
          s.src.includes('@mediapipe/tasks-vision') && s.src.endsWith('vision_bundle.js')
        );
        const base = script && script.src.includes('unpkg.com')
          ? 'https://unpkg.com/@mediapipe/tasks-vision@0.10.3/wasm'
          : 'https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/wasm';

        const vision = await FilesetResolver.forVisionTasks(base);
        landmarker = await PoseLandmarker.createFromOptions(vision, {
          baseOptions: { modelAssetPath: `${base}/pose_landmarker_lite.task` },
          runningMode: 'VIDEO',
          numPoses: 1
        });
        landmarkerReady = true;
        setBadge(true, '検出準備OK', '#2ea043');
        toast('肩検出の準備ができました');
        requestAnimationFrame(tick);
      }catch(e){
        console.warn('Pose 初期化に失敗:', e);
        landmarkerReady = false;
        shoulderOK = true; // 検出不可でも手動表示OK
        setBadge(false, '未対応（手動表示）', '#777');
      }
    }

    // ===== 検出ループ（肩ゲート） =====
    function tick(){
      if(!landmarkerReady || !els.video.srcObject){ requestAnimationFrame(tick); return; }
      const vtime = Math.round(els.video.currentTime * 1000);
      if(vtime === lastVideoTime){ requestAnimationFrame(tick); return; }
      lastVideoTime = vtime;

      const result = landmarker.detectForVideo(els.video, performance.now());
      let ok = false;
      if(result?.landmarks?.length){
        const lm = result.landmarks[0];
        const L = lm[11]; // 左肩
        const R = lm[12]; // 右肩
        if(L && R){
          const vis = (('visibility' in L ? L.visibility : 1) > 0.5) &&
                      (('visibility' in R ? R.visibility : 1) > 0.5);
          const inFrame = L.y>0 && L.y<1 && R.y>0 && R.y<1;
          ok = vis && inFrame;
        }
      }
      shoulderOK = ok;
      setBadge(ok, ok ? '検出中' : '未検出', ok ? '#2ea043' : '#555');
      refreshGarmentDisplay();
      requestAnimationFrame(tick);
    }

    // ===== イベント =====
    els.startBtn.addEventListener('click', async ()=>{
      els.startBtn.disabled = true;
      await startCamera();
      els.startScreen.style.display = 'none';
      if(!landmarkerReady) initPose();
    });
    els.toggle.addEventListener('click', ()=> els.panel.classList.toggle('open'));
    els.modeBtn.addEventListener('click', async ()=>{
      facing = (facing === 'user') ? 'environment' : 'user';
      await startCamera();
    });
    els.mirrorChk.addEventListener('change', applyMirror);
    els.deviceSel.addEventListener('change', async ()=>{
      const id = els.deviceSel.value;
      await startCamera({ deviceId:id });
    });
    els.stopBtn.addEventListener('click', ()=>{ stopStream(); toast('カメラを停止しました'); });
    els.restartBtn.addEventListener('click', async ()=>{ await startCamera(); });

    els.showGarment.addEventListener('change', refreshGarmentDisplay);
    [els.posX, els.posY, els.scale].forEach(el=>{
      el.addEventListener('input', updateGarmentTransform);
    });

    // ===== 初期化 =====
    updateGarmentTransform();
    refreshGarmentDisplay();

    (async ()=>{
      try{
        const res = await fetch('garments.json', { cache:'no-store' });
        if(!res.ok) throw new Error(res.status);
        console.log('garments.json loaded:', await res.json());
      }catch(e){
        console.warn('garments.json が読み込めません。', e);
        toast('garments.json が見つかりません（あとで置けばOK）');
      }
    })();
  </script>
</body>
</html>
