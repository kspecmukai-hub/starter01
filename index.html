<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>starter01 | Camera Base</title>
<style>
  :root{ --ui-bg:#111; --ui-card:#1a1a1a; --ui-fg:#fff; --ui-accent:#4ade80; --hint:#0ea5e9; }
  *{ box-sizing:border-box } html,body{ height:100%; margin:0 }
  body{ background:#000; color:#eaeaea; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif }

  /* ステージ（全画面カメラ） */
  #stage{ position:relative; width:100vw; height:100vh; overflow:hidden; background:#000 }
  #video{ position:absolute; inset:0; width:100%; height:100%; object-fit:cover; background:#000; }
  .mirror{ transform: scaleX(-1); } /* 見た目の左右反転 */

  /* 3パーツ（追従表示用） */
  .part{
    position:absolute; left:50%; top:50%;
    transform:translate(-50%,-50%);
    display:none; pointer-events:none; opacity:0;
    transition: opacity .22s ease;
    will-change:left,top,width,opacity;
  }

  /* スタート画面（カメラ許可） */
  #startScreen{ position:absolute; inset:0; display:grid; place-items:center; background:rgba(0,0,0,.45); }
  #startCard{ background:#111; color:#eaeaea; padding:22px 24px; border-radius:16px; width:min(92vw,520px);
              box-shadow:0 8px 32px rgba(0,0,0,.35); }
  #startCard h1{ margin:0 0 8px; font-size:22px; }
  #startCard p{ margin:10px 0 12px; line-height:1.7; opacity:.9; }
  .btn{ appearance:none; border:0; border-radius:10px; padding:12px 16px; font-weight:700; cursor:pointer; }
  .btn.primary{ background:var(--ui-accent); color:#053; }
  .btn.ghost{ background:#222; color:#eaeaea; }

  /* 設定（最小構成） */
  #panel{ position:absolute; right:18px; bottom:86px; width:320px; max-width:92vw;
          background:rgba(16,16,16,.35); backdrop-filter: blur(6px);
          color:#eaeaea; border-radius:16px; box-shadow:0 8px 32px rgba(0,0,0,.25);
          padding:14px 14px 12px; display:none; }
  #panel.open{ display:block; }
  .row{ display:grid; grid-template-columns:1fr 1fr; gap:8px; align-items:center; margin:8px 0; }
  .row>label{ font-size:12px; opacity:.9 }
  input[type="checkbox"]{ transform:translateY(1px); }
  input[type="range"],select{ width:100%; }
  #toggle{ position:absolute; right:20px; bottom:20px; width:48px; height:48px; border-radius:50%;
           display:grid; place-items:center; background:#10b981; color:#002; font-weight:800; cursor:pointer;
           box-shadow:0 6px 24px rgba(0,0,0,.35); }
</style>
</head>
<body>
  <div id="stage" aria-label="camera stage">
    <video id="video" autoplay playsinline muted></video>

    <!-- 3パーツ -->
    <img id="gBody" class="part" alt="body">
    <img id="gSleeveL" class="part" alt="sleeve_l">
    <img id="gSleeveR" class="part" alt="sleeve_r">

    <!-- スタート -->
    <div id="startScreen">
      <div id="startCard">
        <h1>カメラの準備をします</h1>
        <p>「カメラを開始」を押すと、ブラウザからカメラ許可を聞かれます。<br>インカメで開始し、ミラー表示（左右反転）になります。</p>
        <button id="startBtn" class="btn primary">カメラを開始</button>
        <p style="font-size:11px;opacity:.8">※ 右下の⚙で「アウト/ミラーOFF」へ切替できます。</p>
      </div>
    </div>

    <!-- 設定（簡略） -->
    <div id="panel" role="dialog" aria-modal="false" aria-label="設定">
      <div class="row"><label>カメラ</label>
        <button id="modeBtn" type="button" class="btn ghost" style="padding:8px 10px">イン（ミラーON）に起動中</button></div>
      <div class="row"><label>ミラー</label><input id="mirrorChk" type="checkbox" checked></div>
      <div class="row"><label>横位置（微調整）</label><input id="offX" type="range" min="-80" max="80" value="0"></div>
      <div class="row"><label>縦位置（微調整）</label><input id="offY" type="range" min="-120" max="120" value="0"></div>
      <div class="row"><label>サイズ調整（自動寄与）</label><input id="fitGain" type="range" min="0" max="100" value="100"></div>
      <div class="row"><button id="stopBtn" class="btn ghost">停止</button><button id="restartBtn" class="btn ghost">再起動</button></div>
    </div>

    <button id="toggle" title="設定">⚙</button>
  </div>

<script type="module">
/**** MediaPipe 読込 ****/
import * as vision from './vendor/mediapipe/vision_bundle.mjs';
const WASM_BASE = './vendor/mediapipe/wasm/';

/**** 要素 ****/
const els = {
  stage: document.getElementById('stage'),
  video: document.getElementById('video'),
  startScreen: document.getElementById('startScreen'),
  startBtn: document.getElementById('startBtn'),
  toggle: document.getElementById('toggle'),
  panel: document.getElementById('panel'),
  modeBtn: document.getElementById('modeBtn'),
  mirrorChk: document.getElementById('mirrorChk'),
  offX: document.getElementById('offX'),
  offY: document.getElementById('offY'),
  fitGain: document.getElementById('fitGain'),
  stopBtn: document.getElementById('stopBtn'),
  restartBtn: document.getElementById('restartBtn'),
  gBody: document.getElementById('gBody'),
  gSleeveL: document.getElementById('gSleeveL'),
  gSleeveR: document.getElementById('gSleeveR'),
};

/**** 調整パラメータ ****/
const HOLD_MS = 600;
const ONE_EURO_POS = { mincutoff: 1.2, beta: 0.020, dcutoff: 1.0 };
const ONE_EURO_SCL = { mincutoff: 1.0, beta: 0.010, dcutoff: 1.0 };

/**** 状態 ****/
let stream=null, facing='user', mirror=true, landmarker=null, fileset=null;
let lastDetMS=0;
let cfg=null;         // garments.json の trainer3
let parts=[];         // [{el, natW, natH, anchor:[x,y]}]
let sm={ cx:null, cy:null, s:null };

/**** ユーティリティ ****/
const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));
const lerp  = (a,b,t)=>a+(b-a)*t;

/* OneEuro (超簡易) */
function oneEuro(prev, next, alpha){ return prev==null ? next : prev + (next-prev)*alpha; }

/**** カメラ ****/
function applyMirror(){
  els.video.classList.toggle('mirror', mirror);
  [els.gBody, els.gSleeveL, els.gSleeveR].forEach(el=>el.classList.toggle('mirror', mirror));
}

async function startCamera(){
  try{
    if(stream){ stream.getTracks().forEach(t=>t.stop()); }
    stream = await navigator.mediaDevices.getUserMedia({
      audio:false, video:{ facingMode:facing, width:{ideal:1280}, height:{ideal:720} }
    });
    els.video.srcObject = stream;
    await els.video.play().catch(()=>{});
    els.startScreen.style.display='none';
    applyMirror();
    if(!landmarker){ await initPose(); }
    requestAnimationFrame(tick);
  }catch(e){
    console.error(e); alert('カメラ開始に失敗しました');
  }
}
async function stopCamera(){ if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; } }
async function restartCamera(){ await stopCamera(); await sleep(50); await startCamera(); }

/**** Pose 初期化 ****/
async function initPose(){
  fileset = await vision.FilesetResolver.forVisionTasks(WASM_BASE);
  landmarker = await vision.PoseLandmarker.createFromOptions(fileset, {
    baseOptions:{ modelAssetPath:`${WASM_BASE}pose_landmarker_lite.task` },
    runningMode:'VIDEO', numPoses:1,
    minPoseDetectionConfidence:0.5, minPosePresenceConfidence:0.5, minTrackingConfidence:0.5,
  });
}

/**** 設定読込（garments.json）＆画像プリロード ****/
async function loadConfig(){
  const r = await fetch('garments.json',{cache:'no-store'});
  const data = await r.json();
  cfg = data.trainer3;
  if(!cfg || cfg.type!=='3parts'){ throw new Error('garments.json が 3parts ではありません'); }

  const defAY = (typeof cfg.anchorY==='number')? cfg.anchorY : 0.33;

  const list = [
    {key:'body',    el:els.gBody,    defAnchor:[0.5, defAY]},
    {key:'sleeve_l',el:els.gSleeveL, defAnchor:[0.96, defAY]},
    {key:'sleeve_r',el:els.gSleeveR, defAnchor:[0.04, defAY]},
  ];

  parts = [];
  for(const it of list){
    const p = cfg.parts[it.key];
    const src = (typeof p==='string') ? p : p.src;
    const anc = (p && p.anchor && p.anchor.length===2) ? p.anchor : it.defAnchor;
    it.el.src = src;
    await new Promise(res=>{
      it.el.onload = ()=>{ parts.push({el:it.el, natW:it.el.naturalWidth||1000, natH:it.el.naturalHeight||1000, anchor:anc}); res(); };
      it.el.onerror = ()=>{ console.warn('load error:', src); res(); };
    });
  }
}

/**** 描画（全パーツ） ****/
function drawAll(cx, cy, shoulderPX){
  // 胸幅基準でスケール
  const pxChestHint = cfg.px_chest_hint || 980;
  let chestFromShoulder = shoulderPX;
  if(cfg.chest_cm && cfg.shoulder_cm){
    chestFromShoulder = shoulderPX * (cfg.chest_cm/cfg.shoulder_cm);
  }
  const autoS = pxChestHint>0 ? (chestFromShoulder/pxChestHint) : 1;

  const g = (+els.fitGain.value||100)/100; // 100%=自動に寄せる
  const sTarget = lerp(1, autoS, g);

  // スムージング（軽量OneEuro相当）
  sm.s  = oneEuro(sm.s,  sTarget, 0.12);
  sm.cx = oneEuro(sm.cx, cx,       0.16);
  sm.cy = oneEuro(sm.cy, cy,       0.16);

  const offX = (+els.offX.value)||0;
  const offY = (+els.offY.value)||0;

  const show = true;
  for(const p of parts){
    const w = p.natW * sm.s;
    const h = p.natH * sm.s;
    const ax = p.anchor[0], ay = p.anchor[1];
    const ox = (ax-0.5) * w;
    const oy = (0.5-ay) * h;

    p.el.style.width = `${w}px`;
    p.el.style.left  = `${sm.cx - ox + offX}px`;
    p.el.style.top   = `${sm.cy + oy + offY}px`;
    p.el.style.display = show ? 'block':'none';
    p.el.style.opacity = show ? '1':'0';
  }
}

/**** メインループ ****/
async function tick(){
  if(!landmarker || !els.video || !els.video.videoWidth){ requestAnimationFrame(tick); return; }

  const W = els.stage.clientWidth, H = els.stage.clientHeight;
  const now = performance.now(); let ok=false;

  try{
    const result = landmarker.detectForVideo(els.video, now);
    const lm = (result.landmarks && result.landmarks[0]) ? result.landmarks[0] : null;
    if(lm){
      const L = lm[11], R = lm[12]; // 左右肩
      if(L && R){
        let cx = (L.x + R.x)/2 * W;
        let cy = (L.y + R.y)/2 * H;
        if(mirror){ cx = W - cx; }
        const shoulderPX = Math.abs(R.x - L.x) * W;

        lastDetMS = now; ok = true;
        drawAll(cx, cy, shoulderPX);
      }
    }
  }catch(e){ console.warn('pose detect error:', e); }

  // 一時保持
  const hold = (now - lastDetMS) < HOLD_MS;
  const visible = ok || hold;
  parts.forEach(p=>{
    p.el.style.display = visible ? 'block':'none';
    p.el.style.opacity = visible ? '1' : '0';
  });

  requestAnimationFrame(tick);
}

/**** UI ****/
els.toggle.addEventListener('click', ()=> els.panel.classList.toggle('open'));
els.modeBtn.addEventListener('click', async ()=>{
  facing = (facing==='user') ? 'environment' : 'user';
  mirror = (facing==='user'); applyMirror();
  els.mirrorChk.checked = mirror;
  els.modeBtn.textContent = facing==='user' ? 'イン（ミラーON）に起動中' : 'アウト（ミラーOFF）に起動中';
  await restartCamera();
});
els.mirrorChk.addEventListener('change', ()=>{ mirror = !!els.mirrorChk.checked; applyMirror(); });
['offX','offY','fitGain'].forEach(id=> els[id].addEventListener('input', ()=>{}));
els.startBtn.addEventListener('click', startCamera);
els.stopBtn.addEventListener('click', stopCamera);
els.restartBtn.addEventListener('click', restartCamera);
window.addEventListener('resize', ()=>{ sm={cx:null,cy:null,s:null}; });

/**** 起動 ****/
(async ()=>{
  try{
    await loadConfig();
  }catch(e){
    console.error(e);
    alert('garments.json の読み込み/設定に問題があります。');
  }
  els.mirrorChk.checked = mirror;
  els.modeBtn.textContent = 'イン（ミラーON）に起動中';
})();
</script>
</body>
</html>
