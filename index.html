<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>starter01 | Camera Base</title>
  <style>
    :root{
      --ui-bg:#111; --ui-card:#151515; --ui-fg:#fff; --ui-accent:#22c55e; --hint:#0ea5e9;
      --vh: 1vh; /* iOS 100vh å¯¾ç­– */
    }
    *{ box-sizing:border-box }
    html,body{ height:100%; margin:0 }
    body{ background:#000; color:#eaeaea; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif }

    /* ã‚¹ãƒ†ãƒ¼ã‚¸ï¼ˆ--vhã§é«˜ã•ã‚’åˆ¶å¾¡ï¼‰ */
    #stage{ position:relative; width:100vw; height:calc(var(--vh)*100); overflow:hidden; background:#000 }
    #video{ position:absolute; inset:0; width:100%; height:100%; object-fit:cover; background:#000; }
    .mirror{ transform: scaleX(-1); } /* è¦‹ãŸç›®ã®å·¦å³åè»¢ */

    /* æœPNGï¼ˆè¿½å¾“è¡¨ç¤ºï¼‰ */
    #garment{
      position:absolute; left:50%; top:50%;
      transform:translate(-50%,-50%);
      display:none; pointer-events:none;
      opacity:0; transition: opacity .18s ease;
      will-change:left,top,width,opacity;
    }

    /* ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ */
    #startScreen{ position:absolute; inset:0; display:grid; place-items:center; background:rgba(0,0,0,.55); }
    #startCard{
      background:#111; color:#eaeaea; padding:22px 24px; border-radius:16px; width:min(92vw,520px);
      box-shadow:0 8px 32px rgba(0,0,0,.35);
    }
    #startCard h1{ margin:0 0 10px; font-size:22px; }
    #startCard p{ margin:10px 0 14px; line-height:1.6; opacity:.9; }
    .btn{ appearance:none; border:0; border-radius:12px; padding:13px 16px; font-weight:700; cursor:pointer; }
    .btn.primary{ background:var(--ui-accent); color:#042; }
    .btn.ghost{ background:#1f1f1f; color:#eaeaea; }
    .hint{ font-size:12px; opacity:.8 }

    /* ã‚¹ãƒãƒ›å°‚ç”¨æ¡ˆå†…ï¼ˆPCã§è¡¨ç¤ºï¼‰ */
    #mobileOnly{
      position:fixed; inset:0; display:none; place-items:center; background:#000;
      padding:24px;
    }
    #mobileCard{
      width:min(680px,96vw); background:#0f0f0f; color:#eaeaea; border-radius:16px;
      box-shadow:0 10px 36px rgba(0,0,0,.5); padding:22px;
      text-align:center;
    }
    #mobileCard h1{ margin:0 0 10px; font-size:24px }
    #mobileCard p{ margin:8px 0 14px; line-height:1.7; opacity:.92 }
    #qr{ width:min(280px,60vw); height:auto; margin:10px auto 4px; display:block; }
    .muted{ font-size:13px; opacity:.75 }
    .rowBtns{ display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin-top:12px }
    .btn.smol{ padding:10px 12px; border-radius:10px }

    /* è¨­å®šãƒ‘ãƒãƒ«ï¼ˆã‚¿ãƒƒãƒ—å¤§ãã‚ï¼‰ */
    #panel{
      position:absolute; right:18px; bottom:calc(env(safe-area-inset-bottom,0) + 86px);
      width:min(360px,92vw); background:#0f0f0f; color:#eaeaea;
      border-radius:16px; box-shadow:0 8px 32px rgba(0,0,0,.45); padding:14px 14px 12px; display:none;
    }
    #panel.open{ display:block; }
    #panel h2{ font-size:15px; margin:2px 0 10px; opacity:.9 }
    .row{ display:grid; grid-template-columns:1fr 1fr; gap:10px; align-items:center; margin:10px 0; }
    .row > label{ font-size:13px; opacity:.95 }
    select, input[type="range"]{ width:100%; height:36px }
    input[type="checkbox"]{ width:20px; height:20px }

    /* æµ®éŠãƒœã‚¿ãƒ³ï¼ˆã‚»ãƒ¼ãƒ•ã‚¨ãƒªã‚¢é…æ…®ï¼‰ */
    #toggle{
      position:absolute; right:20px; bottom:calc(env(safe-area-inset-bottom,0) + 20px);
      width:56px; height:56px; border-radius:50%; display:grid; place-items:center;
      background:#10b981; color:#002; font-weight:800; cursor:pointer; font-size:24px;
      box-shadow:0 10px 28px rgba(0,0,0,.35);
    }

    @media (max-width:420px){
      #panel{ right:12px }
      #startCard{ padding:20px; border-radius:12px }
    }
  </style>
</head>
<body>
  <div id="stage" aria-label="camera stage">
    <video id="video" autoplay playsinline muted></video>
    <img id="garment" alt="garment" src="public/garments/trainer.png" />

    <!-- ã‚¹ã‚¿ãƒ¼ãƒˆ -->
    <div id="startScreen">
      <div id="startCard">
        <h1>ã‚«ãƒ¡ãƒ©ã®æº–å‚™ã‚’ã—ã¾ã™</h1>
        <p>ã€Œã‚«ãƒ¡ãƒ©ã‚’é–‹å§‹ã€ã‚’æŠ¼ã™ã¨ã€ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰ã‚«ãƒ¡ãƒ©è¨±å¯ã‚’èã‹ã‚Œã¾ã™ã€‚<br>æ¨™æº–ã¯ã‚¤ãƒ³ã‚«ãƒ¡ãƒ»ãƒŸãƒ©ãƒ¼è¡¨ç¤ºã§ã™ã€‚</p>
        <button id="startBtn" class="btn primary">ã‚«ãƒ¡ãƒ©ã‚’é–‹å§‹</button>
        <p class="hint">â€» å³ä¸‹ã®âš™ã§ã€Œã‚¢ã‚¦ãƒˆ/ãƒŸãƒ©ãƒ¼OFFã€ã¸åˆ‡æ›¿ã§ãã¾ã™ã€‚</p>
      </div>
    </div>

    <!-- è¨­å®š -->
    <div id="panel" role="dialog" aria-modal="false" aria-label="è¨­å®š">
      <h2>è¨­å®š</h2>

      <div class="row">
        <label>ã‚«ãƒ¡ãƒ©</label>
        <button id="modeBtn" type="button" class="btn ghost" style="padding:10px 12px">ã‚¤ãƒ³ï¼ˆãƒŸãƒ©ãƒ¼ONï¼‰ã«èµ·å‹•ä¸­</button>
      </div>

      <div class="row">
        <label>ãƒŸãƒ©ãƒ¼</label>
        <input id="mirrorChk" type="checkbox" checked />
      </div>

      <div class="row">
        <label>ãƒ‡ãƒã‚¤ã‚¹</label>
        <select id="devicesSel"></select>
      </div>

      <div class="row">
        <label>ã‚ªãƒ¼ãƒˆèª¿æ•´</label>
        <input id="autoFitChk" type="checkbox" checked />
      </div>

      <div class="row">
        <label>ãƒ•ã‚£ãƒƒãƒˆä¿è­·èª¿æ•´</label>
        <input id="fitGain" type="range" min="0" max="100" value="70" />
      </div>

      <div class="row">
        <label>æ¨ªä½ç½®ï¼ˆå¾®èª¿æ•´ï¼‰</label>
        <input id="offX" type="range" min="-80" max="80" value="0" />
      </div>
      <div class="row">
        <label>ç¸¦ä½ç½®ï¼ˆå¾®èª¿æ•´ï¼‰</label>
        <input id="offY" type="range" min="-140" max="140" value="12" />
      </div>

      <div class="row">
        <label>ã‚µã‚¤ã‚ºï¼ˆæ‰‹å‹•ï¼‰</label>
        <input id="scale" type="range" min="30" max="150" value="100" />
      </div>

      <div class="row">
        <label>è‚©æ¤œå‡º</label>
        <span id="poseState" style="font-size:13px;background:#0a0;color:#021;border-radius:10px;padding:6px 8px;text-align:center">æ¤œå‡ºä¸­</span>
      </div>

      <div class="row">
        <button id="stopBtn" class="btn ghost">åœæ­¢</button>
        <button id="restartBtn" class="btn ghost">å†èµ·å‹•</button>
      </div>

      <p class="hint">è‚©/è…•ãŒå…¥ã‚‹ã¨è‡ªå‹•ã§è¡¨ç¤ºï¼ˆå°‘ã—ãƒ›ãƒ¼ãƒ«ãƒ‰ï¼‰ã€‚æ¤œå‡ºã§ããªã„ç’°å¢ƒã§ã¯æ‰‹å‹•ã‚µã‚¤ã‚ºèª¿æ•´ã®ã¿åŠ¹ãã¾ã™ã€‚</p>
    </div>

    <button id="toggle" title="è¨­å®š">âš™</button>
  </div>

  <!-- ã‚¹ãƒãƒ›å°‚ç”¨æ¡ˆå†…ï¼ˆPCã®ã¿è¡¨ç¤ºï¼‰ -->
  <div id="mobileOnly">
    <div id="mobileCard">
      <h1>ã“ã®ä½“é¨“ã¯ã‚¹ãƒãƒ›å°‚ç”¨ã§ã™ğŸ“±</h1>
      <p>ãŠæ‰‹å…ƒã®ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ã§ã“ã®ãƒšãƒ¼ã‚¸ã‚’é–‹ã„ã¦ã”åˆ©ç”¨ãã ã•ã„ã€‚<br>ä»¥ä¸‹ã®QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã‚‹ã‹ã€URLã‚³ãƒ”ãƒ¼ã§ã‚¹ãƒãƒ›ã¸å…±æœ‰ã—ã¦ãã ã•ã„ã€‚</p>
      <img id="qr" alt="QR" />
      <div class="muted" id="pageUrl"></div>
      <div class="rowBtns">
        <button id="copyUrl" class="btn smol">URLã‚’ã‚³ãƒ”ãƒ¼</button>
        <!-- é–‹ç™ºãƒ»æ¤œè¨¼ç”¨ã€‚ä¸è¦ãªã‚‰ã“ã®ãƒœã‚¿ãƒ³ã‚’å‰Šé™¤ã—ã¦ãã ã•ã„ -->
        <button id="devContinue" class="btn smol">PCã§ä»®å®Ÿè¡Œï¼ˆé–‹ç™ºç”¨ï¼‰</button>
      </div>
      <p class="muted" style="margin-top:10px">â€»PCãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯ã‚«ãƒ¡ãƒ©æ¤œå‡ºãŒä¸å®‰å®šã«ãªã£ãŸã‚Šã€ã‚µã‚¤ã‚ºåˆã‚ã›ã®ç²¾åº¦ãŒä½ä¸‹ã™ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚</p>
    </div>
  </div>

  <!-- ===== Script ===== -->
  <script type="module">
    /* iOS 100vh å¯¾ç­– */
    const setVh = ()=>{ document.documentElement.style.setProperty('--vh', `${window.innerHeight * 0.01}px`); };
    setVh(); addEventListener('resize', setVh);

    /* ç«¯æœ«åˆ¤å®šï¼šã‚¹ãƒãƒ›ã‹ï¼Ÿ */
    const isMobileDevice = () =>
      /Android|iPhone|iPad|iPod/i.test(navigator.userAgent) || matchMedia('(pointer:coarse)').matches;

    const notice = document.getElementById('mobileOnly');
    const startScreen = document.getElementById('startScreen');
    const qrImg = document.getElementById('qr');
    const pageUrlEl = document.getElementById('pageUrl');

    function applyDeviceGate(forceMobile=false){
      const mobile = forceMobile || isMobileDevice();
      // æ¡ˆå†…ã®è¡¨ç¤ºåˆ‡æ›¿
      notice.style.display = mobile ? 'none' : 'grid';
      startScreen.style.display = mobile ? 'grid' : 'none';
      if(!mobile){
        const url = location.href;
        pageUrlEl.textContent = url;
        // ã‚·ãƒ³ãƒ—ãƒ«ãªQRï¼ˆå¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ä½¿ç”¨ï¼‰ã€‚ä¸è¦ãªã‚‰imgè‡ªä½“ã‚’å‰Šé™¤ã—ã¦ãã ã•ã„
        qrImg.src = 'https://api.qrserver.com/v1/create-qr-code/?size=280x280&data=' + encodeURIComponent(url);
      }
    }
    applyDeviceGate();
    addEventListener('resize', ()=>applyDeviceGate());

    // æ¡ˆå†…å†…ã®ãƒœã‚¿ãƒ³
    document.getElementById('copyUrl').addEventListener('click', async ()=>{
      try{ await navigator.clipboard.writeText(location.href); alert('URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ'); }catch{}
    });
    document.getElementById('devContinue').addEventListener('click', ()=>{
      // é–‹ç™ºç”¨ã«PCã§ã‚‚ç¶šè¡Œ
      applyDeviceGate(true);
    });

    /* MediaPipe (ãƒ­ãƒ¼ã‚«ãƒ«ESM) */
    import * as vision from './vendor/mediapipe/vision_bundle.mjs';
    const WASM_BASE = './vendor/mediapipe/wasm/';

    /* è¦ç´ å‚ç…§ */
    const els = {
      stage:document.getElementById('stage'),
      video:document.getElementById('video'),
      garment:document.getElementById('garment'),
      startBtn:document.getElementById('startBtn'),
      toggle:document.getElementById('toggle'),
      panel:document.getElementById('panel'),
      modeBtn:document.getElementById('modeBtn'),
      mirrorChk:document.getElementById('mirrorChk'),
      devicesSel:document.getElementById('devicesSel'),
      autoFitChk:document.getElementById('autoFitChk'),
      fitGain:document.getElementById('fitGain'),
      offX:document.getElementById('offX'),
      offY:document.getElementById('offY'),
      scale:document.getElementById('scale'),
      poseState:document.getElementById('poseState'),
      stopBtn:document.getElementById('stopBtn'),
      restartBtn:document.getElementById('restartBtn'),
    };

    /* èª¿æ•´ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼ˆãƒ¢ãƒã‚¤ãƒ«å¯„ã›ï¼‰ */
    const ALPHA_POS   = 0.20;   // ä½ç½®ã‚¹ãƒ ãƒ¼ã‚¸ãƒ³ã‚°
    const ALPHA_SCALE = 0.20;   // ã‚¹ã‚±ãƒ¼ãƒ«ã‚¹ãƒ ãƒ¼ã‚¸ãƒ³ã‚°
    const HOLD_MS     = 400;    // ä¸€æ™‚æœªæ¤œå‡ºãƒ›ãƒ¼ãƒ«ãƒ‰
    const ANCHOR_Y_FRAC = 0.28; // æœç”»åƒå†…ã®è‚©ãƒ©ã‚¤ãƒ³ï¼ˆ0=ä¸Šç«¯ã€œ1=ä¸‹ç«¯ï¼‰
    const DROP_K      = 0.12;   // è‚©å¹…pxã«å¯¾ã™ã‚‹ãƒ‰ãƒ­ãƒƒãƒ—å‰²åˆ

    /* çŠ¶æ…‹ */
    let stream=null, currentDeviceId=null, facing='user', mirror=true;
    let landmarker=null, fileset=null;
    let lastDetMS=0, smX=null, smY=null, smS=1, manualScale=1;
    let garmentNatW=0, garmentNatH=0, garmentConf=null;
    let autoDropPx=0;

    els.garment.addEventListener('load', ()=>{
      garmentNatW = els.garment.naturalWidth || 1000;
      garmentNatH = els.garment.naturalHeight || 1000;
    });

    /* ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ */
    const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));
    const lerp  = (a,b,t)=>a+(b-a)*t;

    async function listVideoDevices(){
      try{
        const devices = await navigator.mediaDevices.enumerateDevices();
        const cams = devices.filter(d=>d.kind==='videoinput');
        els.devicesSel.innerHTML = cams.map(d=>{
          const sel = d.deviceId===currentDeviceId ? 'selected':'';
          return `<option value="${d.deviceId}" ${sel}>${d.label||'Camera'}</option>`;
        }).join('');
      }catch{}
    }

    function applyMirror(){
      els.video.classList.toggle('mirror', mirror);
      els.garment.classList.toggle('mirror', mirror);
    }

    async function startCamera(){
      try{
        if(stream){ stream.getTracks().forEach(t=>t.stop()); }

        const constraints = {
          audio:false,
          video:{ facingMode:facing, width:{ideal:1280}, height:{ideal:720}, frameRate:{ideal:30,max:60} }
        };
        if(currentDeviceId) constraints.video.deviceId = { exact: currentDeviceId };

        stream = await navigator.mediaDevices.getUserMedia(constraints);
        els.video.srcObject = stream;
        await els.video.play().catch(()=>{});
        await listVideoDevices();
        document.getElementById('startScreen').style.display = 'none';
        applyMirror();

        if(!landmarker){ await initPose(); }
        requestAnimationFrame(tick);
      }catch(err){
        console.error('startCamera error:', err);
        alert('ã‚«ãƒ¡ãƒ©ã®é–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨±å¯è¨­å®šã‚’ã”ç¢ºèªãã ã•ã„ã€‚');
      }
    }
    async function stopCamera(){ if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; } }
    async function restartCamera(){ await stopCamera(); await sleep(50); await startCamera(); }

    /* Pose åˆæœŸåŒ– */
    async function initPose(){
      try{
        fileset = await vision.FilesetResolver.forVisionTasks(WASM_BASE);
        landmarker = await vision.PoseLandmarker.createFromOptions(fileset, {
          baseOptions:{ modelAssetPath: `${WASM_BASE}pose_landmarker_lite.task` },
          runningMode:'VIDEO', numPoses:1,
          minPoseDetectionConfidence:.5, minPosePresenceConfidence:.5, minTrackingConfidence:.5,
        });
        console.info('Pose åˆæœŸåŒ– OK');
      }catch(e){
        console.error('Pose åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', e);
        alert('å§¿å‹¢æ¤œå‡ºã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆãƒ•ã‚¡ã‚¤ãƒ«é…ç½®ã‚„ãƒ‘ã‚¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼‰');
      }
    }

    /* garments.json èª­è¾¼ */
    async function loadGarmentConfig(){
      try{
        const r = await fetch('garments.json',{cache:'no-store'});
        const data = await r.json();
        const firstKey = Object.keys(data)[0];
        garmentConf = data[firstKey] || null;
      }catch(e){ console.warn('garments.json èª­è¾¼å¤±æ•—:', e); }
    }

    /* è‡ªå‹•ãƒ•ã‚£ãƒƒãƒˆï¼‹æç”» */
    function updateGarmentTransform(){
      if(!garmentNatW || !garmentConf) return;

      // æ‰‹å‹•ã‚¹ã‚±ãƒ¼ãƒ«
      let s = manualScale;

      // è‡ªå‹•ãƒ•ã‚£ãƒƒãƒˆï¼ˆè‚©å¹…â†’èƒ¸å¹…æ¨å®šâ†’px_chest_hintã«åˆã‚ã›ã‚‹ï¼‰
      if(els.autoFitChk.checked && updateGarmentTransform._shoulderPX){
        const pxChestHint = garmentConf.px_chest_hint || 980;
        let targetChestPx = updateGarmentTransform._shoulderPX;
        if(garmentConf.chest_cm && garmentConf.shoulder_cm){
          targetChestPx *= (garmentConf.chest_cm/garmentConf.shoulder_cm);
        }
        const autoS = (pxChestHint>0) ? (targetChestPx / pxChestHint) : s;

        // ãƒ•ã‚£ãƒƒãƒˆä¿è­·èª¿æ•´ï¼šå€¤ãŒå¤§ãã„=æ‰‹å‹•å„ªå…ˆï¼ˆ=è‡ªå‹•ã®å¯„ä¸ã‚’å¼±ã‚ã‚‹ï¼‰
        const protect = (parseInt(els.fitGain.value,10) || 0)/100;   // 0..1
        const autoWeight = 1 - protect; // è‡ªå‹•ã®å¯„ä¸
        s = lerp(s, autoS, autoWeight);
      }

      // ã‚¹ãƒ ãƒ¼ã‚¸ãƒ³ã‚°
      smS = smS==null ? s : lerp(smS, s, ALPHA_SCALE);

      // ä½ç½®ï¼ˆè‚©ã®ä¸­å¿ƒï¼‰
      const cx = updateGarmentTransform._cx ?? (els.stage.clientWidth/2);
      const cy = updateGarmentTransform._cy ?? (els.stage.clientHeight/2);

      smX = smX==null ? cx : lerp(smX, cx, ALPHA_POS);
      smY = smY==null ? cy : lerp(smY, cy, ALPHA_POS);

      const w = garmentNatW * smS;
      const h = garmentNatH * smS;

      // è‚©ãƒ©ã‚¤ãƒ³ï¼ˆANCHOR_Y_FRACï¼‰ã‚’è‚©ä¸­å¿ƒã«åˆã‚ã›ã‚‹
      const anchorOffset = (0.5 - ANCHOR_Y_FRAC) * h;

      // æ‰‹å‹•ã‚ªãƒ•ã‚»ãƒƒãƒˆ
      const offX = parseInt(els.offX.value,10) || 0;
      const offY = parseInt(els.offY.value,10) || 0;

      els.garment.style.width = `${w}px`;
      els.garment.style.left  = `${smX + offX}px`;
      els.garment.style.top   = `${smY + anchorOffset + autoDropPx + offY}px`;
    }

    /* ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ— */
    async function tick(){
      if(!landmarker || !els.video || !els.video.videoWidth){ requestAnimationFrame(tick); return; }

      const W = els.stage.clientWidth, H = els.stage.clientHeight;
      const now = performance.now();
      let ok=false;

      try{
        const result = landmarker.detectForVideo(els.video, now);
        const lm = (result.landmarks && result.landmarks[0]) ? result.landmarks[0] : null;
        if(lm){
          const L = lm[11], R = lm[12];
          if(L && R){
            let cx = (L.x + R.x)/2 * W;
            let cy = (L.y + R.y)/2 * H;
            if(mirror){ cx = W - cx; }

            const shoulderPX = Math.abs(R.x - L.x) * W;
            updateGarmentTransform._shoulderPX = shoulderPX;

            autoDropPx = shoulderPX * DROP_K;
            updateGarmentTransform._cx = cx;
            updateGarmentTransform._cy = cy;

            lastDetMS = now; ok = true;
          }
        }
      }catch(e){ console.warn('pose detect error:', e); }

      // è‡ªå‹•è¡¨ç¤ºï¼šæ¤œå‡ºä¸­ or ç›´è¿‘ãªã‚‰è¡¨ç¤º
      const hold = (now - lastDetMS) < HOLD_MS;
      const wantShow = ok || hold;
      els.garment.style.display = wantShow ? 'block' : 'none';
      els.garment.style.opacity = wantShow ? '1' : '0';

      els.poseState.textContent = ok ? 'æ¤œå‡ºä¸­' : (hold ? 'ä¿æŒä¸­' : 'æœªæ¤œå‡º');
      els.poseState.style.background = ok ? '#0a0' : (hold ? '#996600' : '#555');

      updateGarmentTransform();
      requestAnimationFrame(tick);
    }

    /* ã‚¤ãƒ™ãƒ³ãƒˆ */
    document.getElementById('toggle').addEventListener('click', ()=> els.panel.classList.toggle('open'));

    document.getElementById('modeBtn').addEventListener('click', async ()=>{
      facing = (facing==='user') ? 'environment' : 'user';
      mirror = (facing==='user');
      els.mirrorChk.checked = mirror; applyMirror();
      document.getElementById('modeBtn').textContent = facing==='user' ? 'ã‚¤ãƒ³ï¼ˆãƒŸãƒ©ãƒ¼ONï¼‰ã«èµ·å‹•ä¸­' : 'ã‚¢ã‚¦ãƒˆï¼ˆãƒŸãƒ©ãƒ¼OFFï¼‰ã«èµ·å‹•ä¸­';
      await restartCamera();
    });

    document.getElementById('mirrorChk').addEventListener('change', ()=>{ mirror = !!els.mirrorChk.checked; applyMirror(); });
    document.getElementById('devicesSel').addEventListener('change', async ()=>{ currentDeviceId = els.devicesSel.value || null; await restartCamera(); });

    ['offX','offY','scale','fitGain'].forEach(id=>{
      els[id].addEventListener('input', ()=>{
        if(id==='scale'){ manualScale = (+els.scale.value)/100; }
        updateGarmentTransform();
      });
    });
    els.autoFitChk.addEventListener('change', updateGarmentTransform);

    document.getElementById('startBtn').addEventListener('click', startCamera);
    document.getElementById('stopBtn').addEventListener('click', stopCamera);
    document.getElementById('restartBtn').addEventListener('click', restartCamera);
    addEventListener('resize', ()=>{ smX=null; smY=null; updateGarmentTransform(); });

    // åˆæœŸãƒ­ãƒ¼ãƒ‰
    (async ()=>{
      els.mirrorChk.checked = mirror;
      document.getElementById('modeBtn').textContent = 'ã‚¤ãƒ³ï¼ˆãƒŸãƒ©ãƒ¼ONï¼‰ã«èµ·å‹•ä¸­';
      manualScale = (+els.scale.value)/100;
      await loadGarmentConfig();
    })();
  </script>
</body>
</html>
